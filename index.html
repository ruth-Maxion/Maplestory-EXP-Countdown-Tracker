<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EXP Countdown Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<style>
/* üçé Google/Apple Style Variables */
:root {
  /* Colors */
  --bg-dark: #121212; 
  --bg-light: #f5f5f7; 
  --panel-dark: #1e1e1e; 
  --panel-light: #ffffff; 
  --accent-dark: #0a84ff; 
  --accent-light: #1a73e8; 
  --text-dark: #e5e5e7;
  --text-light: #1c1c1e;
  --muted-dark: #8e8e93;
  --muted-light: #6a6a6a;
  --glass-dark: rgba(255, 255, 255, 0.05);
  --glass-light: rgba(0, 0, 0, 0.03);
  
  /* Styling */
  --border-radius-lg: 12px;
  --border-radius-md: 8px;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  --shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.4);
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
  background: var(--bg-dark);
  color: var(--text-dark);
  transition: background 0.3s, color 0.3s;
  display: flex;
  justify-content: center;
  padding: 20px 0;
}
body.light {
  background: var(--bg-light);
  color: var(--text-light);
}

.card {
  width: 95%;
  max-width: 950px;
  background: var(--panel-dark);
  border-radius: var(--border-radius-lg);
  padding: 30px;
  margin: 0;
  box-shadow: var(--shadow-dark);
  transition: background 0.3s, box-shadow 0.3s;
}
body.light .card {
  background: var(--panel-light);
  box-shadow: var(--shadow);
}

/* üí° NEW: Header with Button */
.header-with-button {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.header-with-button h3 {
    margin-bottom: 0;
}
.header-button {
    font-size: 12px;
    padding: 6px 10px;
    background: var(--glass-dark);
    color: var(--muted-dark);
    border: 1px solid var(--muted-dark);
}
body.light .header-button {
    background: var(--glass-light);
    color: var(--muted-light);
    border: 1px solid var(--muted-light);
}

.section {
  display: flex;
  flex-wrap: wrap;
  gap: 30px;
}
.form, .panel {
  flex: 1 1 450px;
  min-width: 300px;
}

.card-group {
  background: var(--glass-dark);
  padding: 20px;
  border-radius: var(--border-radius-md);
  margin-bottom: 20px;
  border: 1px solid rgba(255, 255, 255, 0.05);
  transition: background 0.3s, border 0.3s;
}
body.light .card-group {
  background: var(--glass-light);
  border: 1px solid rgba(0, 0, 0, 0.08);
}

.row {
  margin-bottom: 15px;
  display: flex;
  flex-direction: column;
}
.row:last-child {
  margin-bottom: 0;
}

label {
  font-size: 13px;
  font-weight: 500;
  color: var(--muted-dark);
  margin-bottom: 6px;
  transition: color 0.3s;
}
body.light label {
  color: var(--muted-light);
}

input[type=number], input[type=text], select {
  padding: 10px 14px;
  border-radius: var(--border-radius-md);
  border: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 16px;
  background: var(--panel-dark);
  color: var(--text-dark);
  transition: background 0.3s, color 0.3s, border-color 0.2s;
}
body.light input, body.light select {
  background: var(--panel-light);
  color: var(--text-light);
  border: 1px solid rgba(0, 0, 0, 0.15);
}
input:focus, select:focus {
  outline: none;
  border-color: var(--accent-dark);
}
body.light input:focus, body.light select:focus {
  border-color: var(--accent-light);
}
input:disabled { opacity: 0.6; }

input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield; 
}

button {
  padding: 10px 14px;
  border-radius: var(--border-radius-md);
  border: none;
  font-weight: 600;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  background: var(--accent-dark); 
  color: #fff;
  transition: background 0.3s, opacity 0.2s, transform 0.1s;
}
body.light button {
  background: var(--accent-light);
}

button.ghost {
  background: transparent !important; 
  border: 1px solid var(--muted-dark);
  color: var(--muted-dark);
}
body.light button.ghost {
  border: 1px solid var(--muted-light);
  color: var(--muted-light);
}

button.warn {
  background: #c44; 
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

button:active:not(:disabled) {
  transform: scale(0.98);
}

/* --- EXP Report Styling (8 Tiles) --- */
.report-grid {
    /* üí° UPDATED: Grid for 8 tiles */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
    gap: 10px;
    margin-top: 5px;
}
.report-item {
    padding: 15px;
    background: var(--glass-dark);
    border-radius: var(--border-radius-md);
    transition: background 0.3s;
}
body.light .report-item {
    background: var(--glass-light);
}
.report-item .value {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-dark);
    display: block;
    margin-top: 5px;
}
body.light .report-item .value {
    color: var(--accent-light);
}
/* üí° NEW: Style for Best/Average Rate */
.report-item.rate-analysis .value {
    color: #34c759;
}
.report-item.best-rate .value {
    color: #ffd60a; 
}

.report-item .label {
    font-size: 11px;
    color: var(--muted-dark);
    text-transform: uppercase;
}
body.light .report-item .label {
    color: var(--muted-light);
}

/* --- History Log Styling (Tiles) --- */
.history-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 250px;
  overflow-y: auto;
  border: none; 
  border-radius: var(--border-radius-md);
  margin-top: 10px;
  padding: 0; 
}

.history-item {
  display: grid;
  grid-template-columns: 1fr auto; 
  column-gap: 15px; 
  padding: 12px 15px;
  border-radius: var(--border-radius-md);
  margin: 0;
  background: var(--panel-dark); 
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15); 
  font-size: 14px;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.3s;
}
body.light .history-item {
    background: var(--panel-light);
    box-shadow: var(--shadow);
}
.history-item.show {
  opacity: 1;
  transform: translateY(0);
}

.history-item-content {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 10px;
}

.history-item .details {
    color: var(--muted-dark);
    font-size: 12px;
    line-height: 1.5;
}
body.light .history-item .details {
    color: var(--muted-light);
}

.history-item .report-summary {
    text-align: right;
    font-weight: 600;
}

.history-item .report-summary .gained {
    color: var(--accent-dark);
    font-size: 15px;
    display: block;
    margin-bottom: 3px;
}
body.light .history-item .report-summary .gained {
    color: var(--accent-light);
}
.history-item .report-summary .rate {
    font-size: 11px;
    color: var(--muted-dark);
}
body.light .history-item .report-summary .rate {
    color: var(--muted-light);
}

.history-item .load-btn-container {
    display: flex;
    align-items: center; 
    justify-content: flex-end;
}
.history-item .load-btn {
    padding: 8px 12px;
    font-size: 12px;
    background: #34c759;
}


/* --- Timer Display & Progress Line (UX) --- */
.timer-container {
    text-align: center;
}
.timer-status {
    font-size: 14px;
    font-weight: 600;
    margin-top: 5px; 
    margin-bottom: 10px;
    color: var(--accent-dark);
    display: block;
    min-height: 20px; 
}
body.light .timer-status {
    color: var(--accent-light);
}

.timer-status.paused {
    color: #ff9500; 
}

.progress-line-container {
    width: 100%;
    height: 8px; 
    background: var(--glass-dark);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 15px; 
}
body.light .progress-line-container {
    background: var(--glass-light);
}

.progress-bar-line {
    height: 100%;
    width: 0%; 
    background: var(--accent-dark);
    transition: width 1s linear, background 0.5s;
    border-radius: 4px;
}
body.light .progress-bar-line {
    background: var(--accent-light);
}

.progress-line-container.warning .progress-bar-line {
    background: #ff9500; 
}
.progress-line-container.paused .progress-bar-line {
    background: #ff9500 !important; 
}


/* Time Display */
.result-item.time-display {
    width: 100%; 
    height: auto; 
    padding: 15px 10px; 
    font-size: 28px;    
    font-weight: 800; 
    text-align: center;
    border-radius: var(--border-radius-md);
    
    background: var(--accent-dark);
    color: #fff;
    
    position: static;
    transform: none;
    box-sizing: border-box; 
}
body.light .result-item.time-display {
    background: var(--accent-light);
    color: #fff;
}
.progress-line-container.warning + .result-item.time-display {
    background: #ff9500; 
}


/* --- Input with Clear Button (UX) --- */
.input-with-clear {
    position: relative;
    display: flex;
}
.input-with-clear input {
    flex-grow: 1;
    padding-right: 40px; 
}
.clear-input {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--muted-dark);
    font-size: 20px; 
    width: 30px;
    height: 30px;
    padding: 0;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
    line-height: 1;
}
.clear-input:hover {
    opacity: 1;
}

/* --- Countdown Overlay (5, 4, 3, 2, 1) --- */
#big-count {
  display: none !important; 
}

.foot {
  text-align: center;
  font-size: 12px;
  color: var(--muted-dark);
  margin-top: 25px;
}
body.light .foot {
  color: var(--muted-light);
}

/* Control Buttons Layout */
.controls {
  display: flex;
  flex-wrap: wrap; 
  justify-content: space-between; 
  gap: 8px; 
}

.controls button {
    flex-grow: 1; 
    min-width: 80px; 
    padding: 10px 8px; 
    font-size: 14px; 
}

@media (max-width: 500px) {
    .controls {
        gap: 6px;
    }
    .controls button {
        flex-basis: calc(50% - 3px); 
    }
    #resetBtn {
        flex-basis: 100%;
        margin-top: 5px;
    }
    #startBtn, #pauseBtn, #resumeBtn, #forceStopBtn {
        flex-basis: calc(50% - 4px);
    }
}


/* üåô Toggle Switch Style */
.toggle-mode-container {
  display: flex;
  align-items: center;
  margin-top: 15px;
  justify-content: flex-end;
}
.switch { position: relative; display: inline-block; width: 50px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background-color: var(--muted-dark); transition: 0.4s; border-radius: 24px;
}
.slider:before {
  position: absolute; content: "üåô"; height: 18px; width: 18px; left: 3px; bottom: 3px;
  background-color: white; transition: 0.4s; border-radius: 50%; display: flex;
  align-items: center; justify-content: center; font-size: 12px;
}
input:checked + .slider { background-color: var(--accent-light); }
body.light input:checked + .slider { background-color: var(--accent-light); }
input:checked + .slider:before { transform: translateX(26px); content: "‚òÄÔ∏è"; }


/* Modal for Ending EXP & Confirmation */
.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.6); 
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.modal-content {
  background: var(--panel-dark);
  margin: 15% auto;
  padding: 30px;
  border-radius: var(--border-radius-lg);
  width: 90%;
  max-width: 400px;
  box-shadow: var(--shadow-dark);
}
body.light .modal-content {
  background: var(--panel-light);
  box-shadow: var(--shadow);
}
.modal-content h3 { margin-top: 0; }

/* small style for modal input buttons */
.modal .controls { margin-top: 14px; }
</style>
</head>
<body>
<div class="card">
  <div class="toggle-mode-container">
    <label class="switch">
      <input type="checkbox" id="toggleMode">
      <span class="slider"></span>
    </label>
  </div>
  
  <div class="section">
    <div class="form">
      <h3>üî¢ Calculation Inputs</h3>
      <div class="card-group">
        <div class="row">
          <label for="startingExp">Starting EXP</label>
          <div class="input-with-clear">
            <input id="startingExp" type="text" placeholder="e.g. 123,456,789"> 
            <button class="clear-input" data-target="startingExp">&times;</button>
          </div>
        </div>
      </div>
      
      <h3>‚è±Ô∏è Timer Controls</h3>
      <div class="card-group">
        <div class="row"><label for="countMin">Countdown Duration (min)</label><input id="countMin" type="number" min="1" value="5"></div>
        
        <div class="row">
          <div class="controls">
            <button id="startBtn">Start</button>
            <button id="pauseBtn" disabled>Pause</button>
            <button id="resumeBtn" disabled>Resume</button>
            <button id="forceStopBtn" disabled class="warn">Force Stop</button>
            <button id="resetBtn" class="ghost" disabled>Reset</button>
          </div>
        </div>
        
        <div class="row timer-container">
            <div id="timerStatus" class="timer-status"></div>
            
            <div class="progress-line-container" id="progressLineContainer">
                <div class="progress-bar-line" id="timerProgressLine"></div>
            </div>
            
            <input id="timeDisplay" type="text" disabled value="00:00:00" class="result-item time-display">
        </div>
      </div>
    </div>
    
    <div class="panel">
      <div class="header-with-button">
          <h3>üìà EXP Report</h3>
          <button id="clearReportBtn" class="header-button ghost">Clear Report</button>
      </div>
      <div class="card-group">
        <div class="report-grid">
          <div class="report-item"><span class="label">Starting EXP</span><span class="value" id="resStart">‚Äî</span></div>
          <div class="report-item"><span class="label">Ending EXP</span><span class="value" id="resEnd">‚Äî</span></div>
          <div class="report-item"><span class="label">Total EXP Gained</span><span class="value" id="resTotal">‚Äî</span></div>
          <div class="report-item"><span class="label">EXP / Hour (Rate)</span><span class="value" id="resHour">‚Äî</span></div>
          <div class="report-item"><span class="label">EXP / 30 min</span><span class="value" id="res30">‚Äî</span></div>
          <div class="report-item"><span class="label">EXP / 10 min</span><span class="value" id="res10">‚Äî</span></div>
          <div class="report-item"><span class="label">EXP / 1 min</span><span class="value" id="res1">‚Äî</span></div>
          <div class="report-item best-rate"><span class="label">Best Rate / Hour</span><span class="value" id="resBestRate">‚Äî</span></div>
          <div class="report-item rate-analysis"><span class="label">Avg Rate (Last 10)</span><span class="value" id="resAvgRate">‚Äî</span></div>
        </div>
      </div>
      
      <h3>üìù Session Details</h3>
      <div class="card-group">
        <div class="row"><label for="noteLevel">Level</label><div class="input-with-clear"><input id="noteLevel" type="text"><button class="clear-input" data-target="noteLevel">&times;</button></div></div>
        <div class="row"><label for="noteClass">Class</label><div class="input-with-clear"><input id="noteClass" type="text"><button class="clear-input" data-target="noteClass">&times;</button></div></div>
        <div class="row"><label for="noteMap">Map</label><div class="input-with-clear"><input id="noteMap" type="text"><button class="clear-input" data-target="noteMap">&times;</button></div></div>
        <div class="row"><label for="noteParty">Party Size</label>
          <select id="noteParty"><option value="Solo">Solo</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
        </div>
      </div>
      
      <div class="header-with-button">
          <h3>üïí History Log</h3>
          <button id="clearHistoryBtn" class="header-button warn">Clear History</button>
      </div>
      <div class="history-container" id="history"></div>
    </div>
  </div>
  <div class="foot">EXP Countdown Tracker ‚Ä¢ Made with ‚ù§Ô∏è by Animal Guild</div>
</div>

<div id="expModal" class="modal" aria-hidden="true">
    <div class="modal-content card" role="dialog" aria-modal="true" aria-labelledby="expModalTitle">
        <h3 id="expModalTitle">Time's Up! Enter Ending EXP</h3>
        <div class="row"><label for="modalEndingExp">Ending EXP</label><input id="modalEndingExp" type="text" placeholder="Enter final EXP here"></div>
        <div class="controls" style="margin-top: 20px; justify-content: flex-end;">
            <button id="modalSubmitBtn" style="flex: 1;">Calculate</button>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal" aria-hidden="true">
    <div class="modal-content card">
        <h3>Confirm Clear History</h3>
        <p>Are you sure you want to delete ALL recorded session history? This action cannot be undone.</p>
        <div class="controls" style="margin-top: 20px; justify-content: flex-end;">
            <button id="confirmCancelBtn" class="ghost" style="flex: 1;">Cancel</button>
            <button id="confirmClearBtn" class="warn" style="flex: 1;">Yes, Clear History</button>
        </div>
    </div>
</div>

<div id="big-count"><div class="num" id="big-num">5</div></div>

<audio id="soundPing" src="https://cdn.jsdelivr.net/gh/animalz-project/assets/soft-ping.mp3" preload="auto"></audio>
<audio id="soundChime" src="https://cdn.jsdelivr.net/gh/animalz-project/assets/soft-chime.mp3" preload="auto"></audio>

<script>
let totalSeconds=0, remainingSeconds=0, elapsedSeconds=0, timerInterval=null, preInterval=null;
let historyData=[];
let tempEndingExpValue = ""; // <-- store typed value while modal open
// üí° FIX 1: ‡πÄ‡∏û‡∏¥‡πà‡∏° Global variable ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö EXP ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
let sessionStartExp = 0; 

const $timeDisplay=$('#timeDisplay');
const $expModal = $('#expModal');
const $modalEndingExp = $('#modalEndingExp');
const $modalSubmitBtn = $('#modalSubmitBtn');
const $timerStatus = $('#timerStatus'); 
const $progressLineContainer = $('#progressLineContainer');
const $timerProgressLine = $('#timerProgressLine');
const $confirmModal = $('#confirmModal');

const $soundPing = $('#soundPing')[0]; 
const $soundChime = $('#soundChime')[0]; 

const DETAILS_KEY = 'exp_tracker_details';
const HISTORY_KEY = 'exp_tracker_history';

// Report fields (for Clear Report)
const reportFields = ['resStart', 'resEnd', 'resTotal', 'resHour', 'res30', 'res10', 'res1', 'resBestRate', 'resAvgRate'];


function playSound(audioElement) {
    if (audioElement) {
        audioElement.currentTime = 0; 
        audioElement.play().catch(e => {/* ignore autoplay errors */});
    }
}

function setProgress(percent) {
    const progressWidth = Math.min(100, Math.max(0, percent)); 
    $timerProgressLine.css('width', `${progressWidth}%`);
}

function fmtSeconds(s){ s=Math.max(0,Math.floor(s)); const h=Math.floor(s/3600).toString().padStart(2,'0'); const m=Math.floor((s%3600)/60).toString().padStart(2,'0'); const sec=Math.floor(s%60).toString().padStart(2,'0'); return `${h}:${m}:${sec}`; }
function numberWithCommas(x){ if (x===null || x===undefined || isNaN(x)) return '‚Äî'; try{ return x.toLocaleString(); }catch(e){ return String(x); } }

function updateOverlay(){ /* No-op kept for compatibility */ }
function showOverlay(){ /* No-op */ }
function hideOverlay(){ /* No-op */ }

// --- UX: Input Formatting (for EXP) ---
function formatNumberInput(inputElement) {
    let value = (inputElement.val() || "").toString().replace(/,/g, '');
    if (value === '') {
        // keep empty (don't force clear) - caller can decide
        return;
    }
    const num = Number(value);
    if (isNaN(num)) {
        // don't clear, leave the raw typed value (we rely on tempEndingExpValue)
        return;
    }
    inputElement.val(num.toLocaleString());
}

// --- Local Storage Functions ---
function saveSessionDetails() {
    const rawStartingExp = ($('#startingExp').val() || '').toString().replace(/,/g, '');
    const details = {
        level: $('#noteLevel').val(),
        class: $('#noteClass').val(),
        map: $('#noteMap').val(),
        party: $('#noteParty').val(),
        countMin: $('#countMin').val(),
        startingExp: rawStartingExp 
    };
    localStorage.setItem(DETAILS_KEY, JSON.stringify(details));
}

function loadSessionDetails() {
    const storedDetails = localStorage.getItem(DETAILS_KEY);
    if (storedDetails) {
        const details = JSON.parse(storedDetails);
        $('#noteLevel').val(details.level || '');
        $('#noteClass').val(details.class || '');
        $('#noteMap').val(details.map || '');
        $('#noteParty').val(details.party || 'Solo');
        $('#countMin').val(details.countMin || '5');
        
        if (details.startingExp) {
            $('#startingExp').val(parseFloat(details.startingExp).toLocaleString());
        } else {
            $('#startingExp').val('');
        }
    }
}

function saveHistory() {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
    updateComparativeRates(); // Update Best/Average Rate every time history changes
}

function loadHistory() {
    const storedHistory = localStorage.getItem(HISTORY_KEY);
    if (storedHistory) {
        historyData = JSON.parse(storedHistory);
        $('#history').empty();
        historyData.slice().reverse().forEach((data, index) => {
            renderHistoryItem(data, historyData.length - 1 - index); 
        });
    }
    updateComparativeRates();
}

// üí° NEW: Update Best/Average Rate Tiles
function updateComparativeRates() {
    if (historyData.length === 0) {
        $('#resBestRate').text('‚Äî');
        $('#resAvgRate').text('‚Äî');
        return;
    }

    // 1. Best EXP Rate
    let maxRate = 0;
    historyData.forEach(item => {
        if (item.perHour > maxRate) {
            maxRate = item.perHour;
        }
    });
    $('#resBestRate').text(numberWithCommas(Math.round(maxRate)));

    // 2. Average EXP Rate (Last 10 sessions)
    const last10 = historyData.slice(-10);
    const totalRate = last10.reduce((sum, item) => sum + item.perHour, 0);
    const avgRate = totalRate / last10.length;
    $('#resAvgRate').text(numberWithCommas(Math.round(avgRate)));
}


// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° ---
function updateControlButtons(state) {
    $('#startBtn, #pauseBtn, #resumeBtn, #forceStopBtn, #resetBtn').attr('disabled', true);
    
    $('#startBtn').css('background', 'var(--accent-dark)');
    $('#pauseBtn').css('background', 'var(--accent-dark)');
    $('#resumeBtn').css('background', 'var(--accent-dark)');
    $('#forceStopBtn').css('background', '#c44'); 

    if (state === 'idle') {
        $('#startBtn').attr('disabled', false).css('background', 'var(--accent-dark)');
        // Reset button only enabled if there was a previous session to reset/clear
        $('#resetBtn').attr('disabled', false); 
    } else if (state === 'running') {
        $('#pauseBtn').attr('disabled', false).css('background', '#ff9500'); 
        $('#forceStopBtn, #resetBtn').attr('disabled', false);
    } else if (state === 'paused') {
        $('#resumeBtn').attr('disabled', false).css('background', '#34c759'); 
        $('#forceStopBtn, #resetBtn').attr('disabled', false);
    } else if (state === 'pre-running') { 
        // Start is disabled, only Reset (Cancel) is enabled
        $('#resetBtn').attr('disabled', false); 
    }
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Timer Display ---
function updateTimerStatus(status) {
    if (status === 'running') {
        $timerStatus.text('COUNTING DOWN').removeClass('paused');
    } else if (status === 'paused') {
        $timerStatus.text('PAUSED').addClass('paused');
    } else {
        $timerStatus.text(''); 
    }
}

function loadSessionFromHistory(data) {
    // 1. Update Session Details
    $('#noteLevel').val(data.details.level || '');
    $('#noteClass').val(data.details.class || '');
    $('#noteMap').val(data.details.map || '');
    $('#noteParty').val(data.details.party || 'Solo');
    
    // 2. Update Inputs for next run (duration and starting exp)
    $('#countMin').val(data.details.countMin || '5');
    $('#startingExp').val(numberWithCommas(data.end)); 
    
    // 3. Update EXP Report (6 tiles + Best/Avg)
    $('#resStart').text(numberWithCommas(data.start)); 
    $('#resEnd').text(numberWithCommas(data.end));     
    $('#resTotal').text(numberWithCommas(data.gained));
    $('#resHour').text(numberWithCommas(Math.round(data.perHour)));
    $('#res30').text(numberWithCommas(Math.round(data.perHour/2)));
    $('#res10').text(numberWithCommas(Math.round(data.perHour/6)));
    $('#res1').text(numberWithCommas(Math.round(data.perHour/60)));
    
    // Best Rate and Avg Rate are handled by updateComparativeRates() 
    
    saveSessionDetails(); 

    alert(`Session from ${new Date(data.timestamp).toLocaleTimeString()} loaded to Report and Details.`);
}


function renderHistoryItem(data, index) {
    const sessionDetails = data.details || { level: '-', class: '-', map: '-', party: 'Solo', countMin: 5 };
    
    const date = new Date(data.timestamp);
    const dateStr = date.toLocaleDateString();
    const timeStr = date.toLocaleTimeString();

    const $item=$(`<div class="history-item">
      <div class="history-item-content">
        <div class="details">
            <div>${dateStr} ${timeStr} (${sessionDetails.countMin} min)</div>
            <div>Lvl ${sessionDetails.level} | ${sessionDetails.class} | ${sessionDetails.party}</div>
            <div>Map: ${sessionDetails.map}</div>
        </div>
        <div class="report-summary">
            <span class="gained">${numberWithCommas(data.gained)} Gained</span>
            <span class="rate">${numberWithCommas(Math.round(data.perHour))} /hr</span>
        </div>
      </div>
      <div class="load-btn-container">
        <button class="load-btn" data-index="${index}">Load Details</button>
      </div>
    </div>`);
    
    $('#history').prepend($item);
    setTimeout(()=>{$item.addClass('show');}, 50);
    
    // Attach click handler for the new Load button
    $item.find('.load-btn').click(function() {
        const idx = $(this).data('index');
        loadSessionFromHistory(historyData[idx]);
    });
}


function addHistory(data){
  const sessionDetails = {
    level: $('#noteLevel').val() || '-',
    class: $('#noteClass').val() || '-',
    map: $('#noteMap').val() || '-',
    party: $('#noteParty').val() || 'Solo',
    countMin: $('#countMin').val() || '5'
  };

  const logData = {
    timestamp: Date.now(),
    details: sessionDetails,
    start: data.start,
    end: data.end,
    gained: data.gained,
    perHour: data.perHour
  };
  
  if (historyData.length >= 30) {
    historyData.shift(); 
    $('#history').children().last().remove(); 
  }
  
  historyData.push(logData);
  saveHistory(); // Calls updateComparativeRates()
  
  // Re-render history for correct index mapping after shift
  $('#history').empty();
  historyData.slice().reverse().forEach((d, index) => {
    renderHistoryItem(d, historyData.length - 1 - index);
  });
}


function performCalculation(){
  // üí° FIX 3: ‡πÉ‡∏ä‡πâ sessionStartExp ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ EXP ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Start
  const start = sessionStartExp; 
  const end = parseFloat($modalEndingExp.val().replace(/,/g, '')) || 0; 
  
  if(isNaN(start)||isNaN(end)||end<start){ 
    alert('Ending EXP must be >= Starting EXP'); 
    return; 
  }

  // üí° FIX 4: (Force Stop) ‡πÉ‡∏ä‡πâ 'totalSeconds' (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ) ‡πÅ‡∏ó‡∏ô 'elapsedSeconds' (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏à‡∏£‡∏¥‡∏á)
  // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Rate ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏´‡∏¢‡∏∏‡∏î
  let calculationSeconds = totalSeconds;
  
  // Fallback: ‡∏ñ‡πâ‡∏≤ totalSeconds ‡πÄ‡∏õ‡πá‡∏ô 0 (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î Reset ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ú‡∏•‡∏≠‡∏Å‡∏î Calculate)
  // ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ elapsedSeconds ‡πÅ‡∏ó‡∏ô (‡∏ã‡∏∂‡πà‡∏á‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
  if (calculationSeconds === 0) {
      calculationSeconds = elapsedSeconds;
  }
  // Fallback ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ 0
  if (calculationSeconds === 0) {
      calculationSeconds = 1; 
  }

  const gained = end-start;
  // ‡πÉ‡∏ä‡πâ calculationSeconds (‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡∏∑‡∏≠ totalSeconds) ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
  const perHour = gained * (3600 / calculationSeconds);
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï EXP Report 
  $('#resStart').text(numberWithCommas(start)); 
  $('#resEnd').text(numberWithCommas(end));     
  $('#resTotal').text(numberWithCommas(gained));
  $('#resHour').text(numberWithCommas(Math.round(perHour)));
  $('#res30').text(numberWithCommas(Math.round(perHour/2)));
  $('#res10').text(numberWithCommas(Math.round(perHour/6)));
  $('#res1').text(numberWithCommas(Math.round(perHour/60)));
  
  addHistory({start,end,gained,perHour});
  
  // **** UX: Smart Default EXP ****
  $('#startingExp').val(numberWithCommas(end)); 
  saveSessionDetails(); 
  
  $expModal.fadeOut(200); 
  tempEndingExpValue = ""; // clear temp after calculation
}

function showEndingExpModal() {
    tempEndingExpValue = ""; // reset temp
    $modalEndingExp.val(''); // clear input on open
    $expModal.fadeIn(200);
    $expModal.attr('aria-hidden', 'false');
    setTimeout(()=> { $modalEndingExp.focus(); }, 220);
}

// ---- FIX: modal protection so clicking outside won't clear the typed value ----
$(document).on('input', '#modalEndingExp', function(){
    tempEndingExpValue = $(this).val();
});

// On blur: if value is empty but we have tempEndingExpValue, restore and format.
// Otherwise format normally.
$('#modalEndingExp').on('blur', function(){
    const $this = $(this);
    const raw = ($this.val() || '').toString();
    if ((raw === '' || isNaN(raw.replace(/,/g,''))) && tempEndingExpValue) {
        // restore typed value
        $this.val(tempEndingExpValue);
        formatNumberInput($this);
    } else {
        // format only if numeric
        formatNumberInput($this);
    }
});

// clicking the modal backdrop SHOULD NOT close the modal nor clear typed value
$('#expModal').on('click', function(e){
    if (e.target === this) {
        // restore typed value to input (if any) and refocus input
        if (tempEndingExpValue) {
            $modalEndingExp.val(tempEndingExpValue);
            formatNumberInput($modalEndingExp);
        }
        // keep modal open, focus input
        setTimeout(()=> { $modalEndingExp.focus(); }, 0);
    }
});

// Modal Calculate button
$modalSubmitBtn.on('click', function(){
    // ensure we format before calculating
    formatNumberInput($modalEndingExp);
    performCalculation();
});

// ---- End modal protection ----

function startCountdown(){
  const min=parseInt($('#countMin').val(),10);
  const startExp=($('#startingExp').val() || '').replace(/,/g, ''); 
  const rawStartExp = parseFloat(startExp); // New line to get the number
  
  if(isNaN(min)||min<=0){ alert('Enter valid minutes'); return; }
  if(!startExp || isNaN(rawStartExp)){ alert('Enter starting EXP'); return; }
  
  // üí° FIX 2: Store the raw starting EXP value immediately upon pressing Start
  sessionStartExp = rawStartExp; 
  
  totalSeconds=min*60; remainingSeconds=totalSeconds; elapsedSeconds=0;
  
  hideOverlay(); 
  $progressLineContainer.removeClass('paused'); 

  // 1. Set control state for pre-running (Disable Pause/Force Stop)
  updateControlButtons('pre-running');

  updateTimerStatus('running');

  saveSessionDetails();
  // Reset Progress Bar
  setProgress(0);
  $progressLineContainer.removeClass('warning');
  
  let pre=5;
  $timeDisplay.val(`START IN ${pre}`); 
  playSound($soundPing); 
  
  preInterval=setInterval(()=>{
    pre--; 
    if(pre>0){ 
        $timeDisplay.val(`START IN ${pre}`); 
        playSound($soundPing); 
    } else{ 
        clearInterval(preInterval); 
        preInterval=null; 
        $timeDisplay.val(fmtSeconds(remainingSeconds)); 
        runMain(); 
        // 2. Set control state for running (Enable Pause/Force Stop)
        updateControlButtons('running'); 
    }
  },1000);

  $timeDisplay.css('background', $('body').hasClass('light') ? 'var(--accent-light)' : 'var(--accent-dark)');
}

function runMain(){
  if(timerInterval) return;
  timerInterval=setInterval(()=>{
    if(remainingSeconds<=0){ 
      clearInterval(timerInterval); 
      timerInterval=null; 
      $timeDisplay.val('00:00:00'); 
      updateTimerStatus('idle'); 
      updateControlButtons('idle'); 
      playSound($soundChime); 
      showEndingExpModal(); 
      return; 
    }
    remainingSeconds--; elapsedSeconds++; 
    $timeDisplay.val(fmtSeconds(remainingSeconds));

    // Update Progress Line
    const percentCompleted = (elapsedSeconds / totalSeconds) * 100;
    setProgress(percentCompleted);
    
    // Warning Color Change (60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
    if (remainingSeconds === 5) {
        playSound($soundPing); 
    }
    
    if (remainingSeconds <= 60 && remainingSeconds > 0) {
        $progressLineContainer.addClass('warning');
        $timeDisplay.css('background', '#ff9500'); 
    } else {
        $progressLineContainer.removeClass('warning');
        $timeDisplay.css('background', $('body').hasClass('light') ? 'var(--accent-light)' : 'var(--accent-dark)');
    }

  },1000);
}

function pauseCountdown(){ 
    if (timerInterval) { clearInterval(timerInterval); timerInterval=null; }
    $progressLineContainer.addClass('paused'); 
    updateControlButtons('paused'); 
    updateTimerStatus('paused');
}
function resumeCountdown(){ 
    if(timerInterval) return; runMain(); 
    $progressLineContainer.removeClass('paused'); 
    updateControlButtons('running'); 
    updateTimerStatus('running');
}

function forceStop(){ 
  if (timerInterval) { clearInterval(timerInterval); timerInterval=null; }
  if (preInterval) { clearInterval(preInterval); preInterval=null; }
  hideOverlay(); 
  updateControlButtons('idle'); 
  updateTimerStatus('idle');
  
  // Reset Progress Bar
  setProgress(0);
  $progressLineContainer.removeClass('warning');
  $progressLineContainer.removeClass('paused'); 
  $timeDisplay.css('background', $('body').hasClass('light') ? 'var(--accent-light)' : 'var(--accent-dark)');
  
  showEndingExpModal(); 
}

function resetCountdown(){ 
  if (timerInterval) { clearInterval(timerInterval); timerInterval=null; }
  if (preInterval) { clearInterval(preInterval); preInterval=null; }
  remainingSeconds=0; elapsedSeconds=0; totalSeconds=0; 
  $timeDisplay.val('00:00:00'); 
  updateControlButtons('idle'); 
  updateTimerStatus('idle');
  $expModal.fadeOut(200); 
  hideOverlay(); 
  // Reset Progress Bar
  setProgress(0);
  $progressLineContainer.removeClass('warning');
  $progressLineContainer.removeClass('paused'); 
  $timeDisplay.css('background', $('body').hasClass('light') ? 'var(--accent-light)' : 'var(--accent-dark)');
  
  // üí° NEW: Clear Report on Reset (as a bonus UX)
  clearReport();
}

// üí° NEW: Clear Report Function
function clearReport() {
    reportFields.forEach(id => {
        $(`#${id}`).text('‚Äî');
    });
}

// üí° NEW: Clear History Functions
function clearHistory() {
    $confirmModal.fadeOut(200); 
    
    // Clear history
    historyData = [];
    localStorage.removeItem(HISTORY_KEY);
    $('#history').empty();
    
    // Reset report tiles (including best/avg rate)
    clearReport();
    
    alert('Session history cleared.');
}


$('#startBtn').click(startCountdown);
$('#pauseBtn').click(pauseCountdown);
$('#resumeBtn').click(resumeCountdown);
$('#forceStopBtn').click(forceStop);
$('#resetBtn').click(resetCountdown);
$modalSubmitBtn.click(performCalculation);

// üí° NEW: Clear Report Button Event
$('#clearReportBtn').click(clearReport);

// üí° NEW: Clear History Button Events
$('#clearHistoryBtn').click(() => {
    $confirmModal.fadeIn(200); 
});
$('#confirmCancelBtn').click(() => {
    $confirmModal.fadeOut(200); 
});
$('#confirmClearBtn').click(clearHistory);


// Event Listeners for Sticky Details
$('#noteLevel, #noteClass, #noteMap, #noteParty, #countMin').on('change keyup', saveSessionDetails);

// Starting/Ending EXP: ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
$('#startingExp').on('blur', function() {
    formatNumberInput($(this));
}).on('change keyup', saveSessionDetails);

// modal input formatting - already handled above with safer logic
// $('#modalEndingExp').on('blur', function() { formatNumberInput($(this)); }); // replaced by safer handler

// Event Listeners: Clear Buttons
$('.clear-input').click(function() {
    const targetId = $(this).data('target');
    $('#' + targetId).val('');
    if (targetId === 'startingExp') {
        formatNumberInput($('#' + targetId));
    }
    saveSessionDetails(); 
});

$('#toggleMode').click(()=>{
  const isLight = $('body').toggleClass('light').hasClass('light');
  const state = timerInterval ? 'running' : preInterval ? 'pre-running' : 'idle'; 
  updateControlButtons(state); 

  if (!timerInterval) { 
    $timeDisplay.css('background', isLight ? 'var(--accent-light)' : 'var(--accent-dark)');
  }
});

// Initial Setup
$(document).ready(() => {
    updateControlButtons('idle');
    updateTimerStatus('idle');
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadSessionDetails();
    loadHistory(); 
});
</script>
</body>
</html>